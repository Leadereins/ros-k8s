# implement_phase

严格执行架构计划中的**单个 Phase**，把计划文档中的"修改文件 + 具体变更 + 验证命令 + 成功判据"落实到代码与配置，并立即完成自动验证与可审计的 Phase 完成报告。

本命令面向 Claude Code 的 vibe coding 工作流：强调执行纪律、范围控制与验证闭环。

---

## 目标（Goals）

1. **一次只实现一个 Phase**：严格按计划执行，不跨 Phase、不扩展范围。
2. **变更可审计**：先列出将修改的文件，再实施变更；最终汇总每个文件的变更要点。
3. **验证闭环**：Phase 完成后立即运行计划定义的自动验证命令，并报告结果。
4. **产出 Phase 完成报告**：写入 `thoughts/shared/phase_reports/`，便于追踪迭代与回滚。

---

## 硬性约束（Non-negotiable）

1. 一次只执行一个 Phase（用户指定）。
2. 不允许扩大范围：

   * 不新增计划外功能
   * 不重构非必要模块
   * 不"顺手修复"与当前 Phase 无关问题
3. 变更必须与计划一致：若发现计划存在错误/缺失，必须停止执行，先反馈并要求更新计划文档。
4. 自动验证必须执行：

   * 若验证命令不可运行，必须说明原因，并给出"修复验证环境"的最小变更建议（仍不得扩展 Phase）。
5. 若自动验证失败：不得继续推进下一 Phase，必须先定位原因并提出最小修复路径。

---

## 输入（Inputs）

用户必须提供：

* 架构计划文档路径：例如 `thoughts/shared/plans/YYYY-MM-DD_ros_k8s_architecture.md`
* Phase 编号：例如 `Phase 1` / `Phase 2` … `Phase 5`

可选输入（若计划文档中已涵盖则可省略）：

* 目标集群上下文（kubeconfig context）
* 镜像仓库前缀/命名空间

---

## 输出（Outputs）

必须写入：

* `thoughts/shared/phase_reports/YYYY-MM-DD_PhaseN_implementation_report.md`

完成后聊天输出（必须且仅一句）：

* `Phase implementation completed.`

---

## 执行流程（模块化步骤）

### Step 0：读取计划并锁定 Phase

1. 打开计划文档，定位用户指定的 Phase。
2. 抽取并冻结以下信息（作为"执行合同"，后续不得偏离）：

   * 目标（Goal）
   * 修改文件清单（路径级）
   * 具体变更点（应达到的行为/结构）
   * 执行命令
   * 自动验证命令
   * 成功判据

输出要求：

* 在 Phase 报告中写出"Phase 合同摘要"。

---

### Step 1：列出即将修改的文件（必须在任何改动前完成）

1. 基于计划文档列出"即将修改"的文件路径。
2. 对每个文件补充：

   * 变更类型（新增/修改/删除）
   * 变更意图（一句话）
   * 风险点（例如：构建链、entrypoint、K8s env 注入、DDS 配置）

纪律：

* 若实际需要修改的文件不在计划清单中，必须停止并反馈"计划缺失"，等待计划更新。

---

### Step 2：执行代码/配置变更（严格按计划）

执行规则：

* 按计划逐文件实施变更。
* 每完成一个文件，立即做最小自检（语法/格式/引用路径正确性）。
* 变更应追求"最小闭环"：只实现该 Phase 成功判据所必需的内容。

记录要求：

* 在 Phase 报告里为每个文件写：

  * 变更摘要（要点）
  * 关键 diff 片段（不贴整文件；仅贴关键几段）

---

### Step 3：运行自动验证命令（必须）

1. 严格运行计划中定义的"自动验证命令"。
2. 若计划包含多个验证层级，按顺序执行：

   * ROS2 构建/运行验证（例如 `colcon build` / `ros2 launch`）
   * Docker 构建/运行验证（例如 `docker build` / `docker run`）
   * K8s 部署/运行验证（例如 `kubectl apply` / `kubectl rollout status` / `kubectl logs`）

输出要求：

* 必须记录每条命令的：

  * 命令文本
  * 关键输出（成功/失败摘要）
  * 返回码（如可得）

失败处理（强制）：

* 若失败：

  1. 报告具体错误信息
  2. 定位可能原因（与本 Phase 相关）
  3. 给出最小修复方案（仍需符合 Phase 范围）
  4. 修复后重跑验证

---

### Step 4：列出手动验证项（来自计划，必须输出清单）

* 从计划文档提取"手动验证"检查项。
* 若计划未列出手动验证项，则补充最小必要项（不得扩展范围）：

  * ROS2：`ros2 topic list` / `ros2 topic echo <topic>`
  * K8s：`kubectl get pods -A -o wide` / `kubectl describe pod <...>`

输出格式：checkbox 列表。

---

### Step 5：生成 Phase 完成报告（必须落盘）

写入：`thoughts/shared/phase_reports/YYYY-MM-DD_PhaseN_implementation_report.md`

报告结构（标题必须一致）：

1. `# Phase N Implementation Report`
2. `## 计划文档`

   * 计划路径
   * Phase 名称
3. `## Phase 合同摘要`

   * 目标
   * 修改文件清单
   * 自动验证命令
   * 成功判据
4. `## 实施变更`

   * 逐文件：路径｜变更类型｜变更摘要｜关键片段
5. `## 自动验证结果`

   * 命令清单（含输出摘要与状态）
6. `## 手动验证清单（待用户确认）`

   * checkbox
7. `## 完成状态`

   * 成功 / 失败（失败必须附原因与下一步）
8. `## 下一步建议`

   * 若成功：建议进入下一 Phase（但不自动执行）
   * 若失败：建议修复步骤与重跑命令

---

## 异常处理（必须遵守）

### A. 发现计划有误或不完整

必须停止执行并输出：

1. 计划错误点（引用计划文档段落）
2. 为什么会阻塞实施
3. 建议如何更新计划（给出具体改动建议）
4. 等待用户更新计划文档后再继续

### B. 用户要求超出当前 Phase

必须回应：

1. 该请求不属于当前 Phase 范围
2. 建议把该需求放入哪个 Phase 或在计划文档新增 Phase/任务
3. 不执行该请求的实现变更

---

## 完成条件

* 已按计划完成本 Phase 的所有文件变更。
* 已运行并记录全部自动验证命令及结果。
* 已生成并写入 Phase 完成报告到 `thoughts/shared/phase_reports/`。
* 聊天输出仅一句：`Phase implementation completed.`
